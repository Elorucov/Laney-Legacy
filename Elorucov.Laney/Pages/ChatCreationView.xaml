<Page
    x:Class="Elorucov.Laney.Pages.ChatCreationView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:Elorucov.Laney.Pages"
    xmlns:ctrls="using:Elorucov.Laney.Controls"
    xmlns:muxc="using:Microsoft.UI.Xaml.Controls"
    xmlns:elor="using:Elorucov.Toolkit.UWP.Controls"
    xmlns:vkobj="using:Elorucov.VkAPI.Objects"
    xmlns:converters="using:Elorucov.Laney.Services.Converters.ConversationsList"
    xmlns:converters2="using:Elorucov.Laney.Services.Converters.MessageItem"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <Page.Resources>
        <converters:OnlineInfoToIndicatorConverter x:Key="online"/>
        <converters2:NullToVisibility x:Key="ntv"/>
        <converters2:NullToVisibility2 x:Key="vtn"/>
        
        <CollectionViewSource x:Name="FriendsGroups" x:Key="FriendsGroups" IsSourceGrouped="True" Source="{Binding GroupedFriends, Mode=TwoWay}" ItemsPath="Items"/>
        
        <DataTemplate x:Key="UserTemplate" x:DataType="vkobj:User">
            <Grid Margin="4,6,2,6">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <elor:Avatar IsHitTestVisible="False" Width="42" Height="42" Margin="0,0,12,0" Grid.RowSpan="2" ImageSource="{x:Bind Photo, Converter={StaticResource bic}, ConverterParameter=ava, Mode=OneWay}" DisplayName="{x:Bind FullName, Mode=OneWay}"/>
                <ContentPresenter Visibility="{x:Bind OnlineInfo.isOnline, Mode=OneWay, Converter={StaticResource ntv}}" HorizontalAlignment="Right" VerticalAlignment="Bottom" Margin="0,0,10,0" ContentTemplate="{x:Bind OnlineInfo, Mode=OneWay, Converter={StaticResource online}}"/>
                
                <TextBlock Grid.Column="1" VerticalAlignment="Center" Text="{x:Bind FullName}" FontWeight="SemiBold" TextLineBounds="TrimToBaseline" FontSize="16">
                    <TextBlock.RenderTransform>
                        <CompositeTransform TranslateY="-3"/>
                    </TextBlock.RenderTransform>
                </TextBlock>

                <Button Grid.Column="2" Click="GoToChat">
                    <ctrls:FixedFontIcon Glyph=""/>
                </Button>
            </Grid>
        </DataTemplate>
    </Page.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <StackPanel Height="48" Orientation="Horizontal">
                <HyperlinkButton x:Uid="backButton" Grid.Column="0" Height="48" Width="48" FontSize="16" FontFamily="{StaticResource SymbolThemeFontFamily}" Content="" Click="GoBack"/>
                <TextBlock VerticalAlignment="Center" Style="{StaticResource BaseTextBlockStyle}" FontSize="15" LineHeight="22" x:Uid="new_chat"/>
            </StackPanel>
            <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" Margin="6">
                <Button Margin="6" Command="{Binding CustomizeChatSetingsCommand}" x:Uid="settingsbtn"/>
                <Button Style="{StaticResource AccentButtonStyle}" Margin="6" IsEnabled="{Binding CanCreateChat}" Command="{Binding CreateCommand}" x:Uid="createbtn"/>
            </StackPanel>
        </Grid>

        <Rectangle x:Name="Separator1" Grid.Row="1" VerticalAlignment="Bottom" Height="1" Margin="12,0" Fill="{ThemeResource DividerStrokeColorDefaultBrush}"/>
        <Grid Grid.Row="1" Margin="12,8,12,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition/>
            </Grid.ColumnDefinitions>
            <Grid Width="72" Height="72" Margin="0,0,12,0">
                <Ellipse Fill="{ThemeResource ControlAltFillColorQuarternaryBrush}"/>
                <ctrls:FixedFontIcon FontSize="24" Glyph="" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                <Ellipse>
                    <Ellipse.Fill>
                        <ImageBrush ImageSource="{Binding ChatPhotoPreview}" AlignmentX="Center" AlignmentY="Center" Stretch="UniformToFill"/>
                    </Ellipse.Fill>
                </Ellipse>
                <HyperlinkButton x:Name="ChatPhotoChooseButton" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Opacity="0" Command="{Binding ChatPhotoSetCommand}" CommandParameter="{Binding ElementName=ChatPhotoChooseButton}"/>
            </Grid>
            <StackPanel Grid.Column="1">
                <TextBox x:Name="ChatNameBox" Text="{Binding ChatName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" x:Uid="convcreate_tb"/>
                <TextBlock Style="{StaticResource CaptionTextBlockStyle}" Margin="0,8,0,0" Foreground="{ThemeResource TextFillColorSecondaryBrush}" MaxLines="2" x:Uid="new_chat_footnote"/>
            </StackPanel>
        </Grid>

        <Rectangle x:Name="Separator2" Grid.Row="2" VerticalAlignment="Bottom" Height="1" Margin="12,0" Visibility="{Binding SelectedFriends, Converter={StaticResource ntv}}" Fill="{ThemeResource DividerStrokeColorDefaultBrush}"/>
        
        <GridView Grid.Row="2" Margin="6,0" Visibility="{Binding SelectedFriends, Converter={StaticResource ntv}}" SelectionMode="None" ItemsSource="{Binding SelectedFriends}" MaxHeight="128" ScrollViewer.VerticalScrollBarVisibility="Auto">
            <GridView.ItemsPanel>
                <ItemsPanelTemplate>
                    <!-- Мыслант гигысли, отец XAML-вёрстки -->
                    <ctrls:WrapPanel Margin="0,0,0,-3"/>
                    <!-- Дело в том, что без -3 отступ между нижними "чипсами" и сепаратором становится 9 px. -->
                </ItemsPanelTemplate>
            </GridView.ItemsPanel>
            <GridView.Style>
                <Style TargetType="GridView">
                    <Setter Property="MinHeight" Value="0"/>
                </Style>
            </GridView.Style>
            <GridView.ItemContainerStyle>
                <Style TargetType="GridViewItem">
                    <Style.Setters>
                        <Setter Property="MinWidth" Value="0" />
                        <Setter Property="MinHeight" Value="0" />
                        <Setter Property="Margin" Value="0" />
                        <Setter Property="Padding" Value="0" />
                        <Setter Property="BorderThickness" Value="0" />
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="GridViewItem">
                                    <GridViewItemPresenter BorderBrush="Transparent" FocusBorderBrush="Transparent"/>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style.Setters>
                </Style>
            </GridView.ItemContainerStyle>
            <GridView.ItemTemplate>
                <DataTemplate x:DataType="vkobj:User">
                    <Border Margin="6,6,0,0" Height="30" Background="{ThemeResource ControlFillColorDefaultBrush}" BorderBrush="{ThemeResource ControlStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="4">
                        <StackPanel Orientation="Horizontal">
                            <elor:Avatar Width="20" Height="20" Margin="7,4,0,4" ImageSource="{x:Bind Photo, Converter={StaticResource bic}, ConverterParameter=ava, Mode=OneWay}" DisplayName="{x:Bind FirstName, Mode=OneWay}"/>
                            <TextBlock FontSize="14" FontWeight="SemiBold" Margin="6,-2,6,0" VerticalAlignment="Center" Text="{x:Bind FirstName}"/>
                            <HyperlinkButton Width="20" Height="20" Margin="0,4,7,4" Padding="0" Click="RemoveFromSelected">
                                <ctrls:FixedFontIcon Glyph="" FontSize="10" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                            </HyperlinkButton>
                        </StackPanel>
                    </Border>
                </DataTemplate>
            </GridView.ItemTemplate>
        </GridView>

        <!-- Тяжело будет реализовать поиск при Semantic zoom, так что пока отложим эту затею. -->
        <!-- Всё-равно можно нажать на букву между группами и быстро найти друга. -->
        <Grid x:Name="SomethingHard" Grid.Row="3" x:DeferLoadStrategy="Lazy">
            <Grid.Resources>
                <x:Double x:Key="TextControlBorderThemeThicknessFocused">0</x:Double>
            </Grid.Resources>
            <AutoSuggestBox Background="Transparent" BorderThickness="0" BorderBrush="Transparent" Margin="1,0,0,0" Text="{Binding SearchQuery, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" PlaceholderText="Search friends" QueryIcon="Find"/>
        </Grid>

        <SemanticZoom Grid.Row="4">
            <SemanticZoom.ZoomedInView>
                <ListView x:Name="FriendsList" ItemsSource="{Binding Source={StaticResource FriendsGroups}, Mode=OneWay}" SelectionMode="Multiple" ItemTemplate="{StaticResource UserTemplate}" SelectionChanged="UpdateSelectedFriends">
                    <ListView.GroupStyle>
                        <GroupStyle HidesIfEmpty="True">
                            <GroupStyle.HeaderTemplate>
                                <DataTemplate>
                                    <TextBlock Style="{ThemeResource BodyStrongTextBlockStyle}" Margin="14,10,0,2" Text="{Binding Name}" VerticalAlignment="Bottom"/>
                                </DataTemplate>
                            </GroupStyle.HeaderTemplate>
                        </GroupStyle>
                    </ListView.GroupStyle>
                </ListView>
            </SemanticZoom.ZoomedInView>
            <SemanticZoom.ZoomedOutView>
                <GridView ItemsSource="{Binding Source={StaticResource FriendsGroups}, Path=CollectionGroups}" HorizontalAlignment="Center" VerticalAlignment="Center" MaxWidth="420">
                    <GridView.ItemTemplate>
                        <DataTemplate>
                            <Border Background="Transparent" Width="48" Height="48" Margin="4">
                                <TextBlock Text="{Binding Group.Icon}"
                               FontFamily="{Binding Group.IconFontFamily}"
                               FontSize="24"
                               HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                        </DataTemplate>
                    </GridView.ItemTemplate>
                </GridView>
            </SemanticZoom.ZoomedOutView>
        </SemanticZoom>
        <muxc:ProgressRing Grid.Row="4" IsActive="{Binding IsLoading}"/>
        <StackPanel Grid.Row="4" HorizontalAlignment="Center" VerticalAlignment="Center" Margin="16,0" Padding="24,0" CornerRadius="{StaticResource OverlayCornerRadius}" Visibility="{Binding Placeholder, Converter={StaticResource ntv}}">
            <ctrls:FixedFontIcon Margin="0,24,0,0" FontSize="48" Glyph="{Binding Placeholder.Icon}"/>
            <TextBlock Margin="0,10,0,0" TextAlignment="Center" TextWrapping="Wrap" Style="{StaticResource SubtitleTextBlockStyle}" Visibility="{Binding Placeholder.Header, Converter={StaticResource ntv}}" Text="{Binding Placeholder.Header}"/>
            <TextBlock Margin="0,10,0,0" TextAlignment="Center" TextWrapping="Wrap" Style="{StaticResource BodyTextBlockStyle}" Visibility="{Binding Placeholder.Content, Converter={StaticResource ntv}}" Text="{Binding Placeholder.Content}"/>
            <Button Margin="0,16,0,24" Tag="retry" HorizontalAlignment="Center" Style="{StaticResource AccentButtonStyle}" Visibility="{Binding Placeholder.ActionButton, Converter={StaticResource ntv}}" Content="{Binding Placeholder.ActionButton}" Command="{Binding Placeholder.ActionButtonCommand, Mode=OneWay}"/>
        </StackPanel>

        <!--<StackPanel Grid.Row="5" Orientation="Horizontal" HorizontalAlignment="Right" Margin="6">
            <Button Margin="6" Command="{Binding CustomizeChatSetingsCommand}" Content="Chat settings"/>
            <Button Style="{StaticResource AccentButtonStyle}" Margin="6" Command="{Binding CreateCommand}" Content="Create"/>
        </StackPanel>-->
    </Grid>
</Page>