<UserControl
    x:Class="Elorucov.Laney.Controls.PostComposer"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:win1809="http://schemas.microsoft.com/winfx/2006/xaml/presentation?IsApiContractPresent(Windows.Foundation.UniversalApiContract, 7)"
    xmlns:nonWin1809="http://schemas.microsoft.com/winfx/2006/xaml/presentation?IsApiContractNotPresent(Windows.Foundation.UniversalApiContract, 7)"
    xmlns:local="using:Elorucov.Laney.Controls"
    xmlns:vmc="using:Elorucov.Laney.ViewModel.Controls"
    xmlns:muxc="using:Microsoft.UI.Xaml.Controls"
    xmlns:conv="using:Elorucov.Laney.Services.Converters"
    xmlns:converters2="using:Elorucov.Laney.Services.Converters.MessageItem"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    d:DesignHeight="300"
    d:DesignWidth="360">

    <UserControl.Resources>
        <converters2:NullToVisibility x:Key="ntv"/>
        <conv:ValueToBool x:Key="vtb"/>
        <conv:ExactlyValueConverter x:Key="evc"/>
        <conv:GeopointToString x:Key="gps"/>
        <converters2:DateTimeToCompactString x:Key="dtc"/>

        <x:Double x:Key="SplitButtonPrimaryButtonSize">30</x:Double>
        <x:Double x:Key="SplitButtonSecondaryButtonSize">31</x:Double>

        <Style x:Key="AttachButtonStyle" TargetType="Button">
            <Setter Property="CornerRadius" Value="{StaticResource ControlCornerRadius}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="7"/>
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="FontFamily" Value="{StaticResource SymbolThemeFontFamily}"/>
        </Style>

        <win1809:Style x:Key="LeftSideButtonStyle" TargetType="Button" BasedOn="{StaticResource AttachButtonStyle}">
            <Setter Property="CornerRadius" Value="4,0,0,4"/>
        </win1809:Style>
        <win1809:Style x:Key="MiddleSideButtonStyle" TargetType="Button" BasedOn="{StaticResource AttachButtonStyle}">
            <Setter Property="BorderThickness" Value="0,1,1,1"/>
            <Setter Property="CornerRadius" Value="0"/>
        </win1809:Style>
        <win1809:Style x:Key="RightSideButtonStyle" TargetType="Button" BasedOn="{StaticResource AttachButtonStyle}">
            <Setter Property="BorderThickness" Value="0,1,1,1"/>
            <Setter Property="CornerRadius" Value="0,4,4,0"/>
        </win1809:Style>

        <nonWin1809:Style x:Key="AttachButtonStyleLegacy" TargetType="Button" BasedOn="{StaticResource DefaultButtonStyle}">
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="MinWidth" Value="32"/>
            <Setter Property="Padding" Value="7"/>
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="FontFamily" Value="{StaticResource SymbolThemeFontFamily}"/>
        </nonWin1809:Style>

        <nonWin1809:Style x:Key="LeftSideButtonStyleLegacy" TargetType="Button" BasedOn="{StaticResource AttachButtonStyle}">
            
        </nonWin1809:Style>
        <nonWin1809:Style x:Key="MiddleSideButtonStyleLegacy" TargetType="Button" BasedOn="{StaticResource AttachButtonStyle}">
            <Setter Property="BorderThickness" Value="0,1,1,1"/>
        </nonWin1809:Style>
        <nonWin1809:Style x:Key="RightSideButtonStyleLegacy" TargetType="Button" BasedOn="{StaticResource AttachButtonStyle}">
            <Setter Property="BorderThickness" Value="0,1,1,1"/>
        </nonWin1809:Style>

        <Flyout x:Name="DonsParamsFlyout" Placement="Bottom">
            <StackPanel Width="318">
                <Grid Margin="6">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="140"/>
                        <ColumnDefinition/>
                    </Grid.ColumnDefinitions>
                    <ComboBox Grid.Column="0" Margin="6,4,6,6" x:Uid="feed_composer_visibility" SelectedIndex="{Binding DonSetting, Mode=TwoWay}">
                        <ComboBoxItem x:Uid="feed_composer_visibility_all"/>
                        <ComboBoxItem x:Uid="feed_composer_donut_visibility_dons"/>
                    </ComboBox>

                    <ComboBox Grid.Column="1" Margin="6,4,6,6" HorizontalAlignment="Stretch" x:Uid="feed_composer_donut_open_after"  Visibility="{Binding DonSetting, Mode=OneWay, Converter={StaticResource evc}, ConverterParameter=1}" SelectedIndex="{Binding PublishToNonDonsAfterDays, Mode=TwoWay}">
                        <ComboBoxItem x:Uid="feed_composer_donut_open_after_never"/>
                        <ComboBoxItem x:Uid="feed_composer_donut_open_after_1d"/>
                        <ComboBoxItem x:Uid="feed_composer_donut_open_after_2d"/>
                        <ComboBoxItem x:Uid="feed_composer_donut_open_after_3d"/>
                        <ComboBoxItem x:Uid="feed_composer_donut_open_after_4d"/>
                        <ComboBoxItem x:Uid="feed_composer_donut_open_after_5d"/>
                        <ComboBoxItem x:Uid="feed_composer_donut_open_after_6d"/>
                        <ComboBoxItem x:Uid="feed_composer_donut_open_after_7d"/>
                    </ComboBox>
                </Grid>
                <!--<TextBlock TextWrapping="Wrap" Margin="12,0,12,12" Style="{StaticResource BodyTextBlockStyle}" Foreground="{ThemeResource TextFillColorTertiaryBrush}">
                    <Run FontWeight="SemiBold" Text="Please note:"/>
                    <Run Text="You can publish posts for dons, but Laney can't display these posts yet."/>
                </TextBlock>-->
            </StackPanel>
        </Flyout>
        
        <Flyout x:Name="PostParamsFlyout" x:Key="PostParamsFlyout" Placement="Bottom" Opened="PostParamsFlyout_Opened">
            <StackPanel Margin="6" Width="318">
                <Grid x:Name="PrimaryAttachmentsModeSettings" Visibility="{Binding HasPreviewableAttachments, Converter={StaticResource ntv}}">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition/>
                        <ColumnDefinition/>
                    </Grid.ColumnDefinitions>
                    <RadioButton x:Name="pamRb1" Grid.Column="0" Margin="6,0" GroupName="PAM" Tag="0" Checked="ChangePrimaryAttachmentsMode" x:Uid="feed_composer_pam_grid"/>
                    <RadioButton x:Name="pamRb2" Grid.Column="1" Margin="6,0" GroupName="PAM" Tag="1" Checked="ChangePrimaryAttachmentsMode" x:Uid="feed_composer_pam_carousel"/>
                </Grid>
                <TextBlock Visibility="{Binding HasPreviewableAttachments, Converter={StaticResource ntv}}" TextWrapping="Wrap" Margin="6,0,6,12" Style="{StaticResource BodyTextBlockStyle}" Foreground="{ThemeResource TextFillColorTertiaryBrush}">
                    <Run FontWeight="SemiBold" x:Uid="feed_composer_pam_note_header"/>
                    <Run x:Uid="feed_composer_pam_note"/>
                </TextBlock>

                <Grid x:Name="VisibilityInfo" Visibility="{Binding IsPrivacyAvailable, Converter={StaticResource ntv}}">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="96"/>
                        <ColumnDefinition/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Margin="6,0,0,0" VerticalAlignment="Center" x:Uid="feed_composer_visibility_t"/>
                    <ComboBox Grid.Column="1" Margin="6" HorizontalAlignment="Stretch" SelectedIndex="{Binding Privacy, Mode=TwoWay}">
                        <ComboBoxItem x:Uid="feed_composer_visibility_all"/>
                        <ComboBoxItem x:Uid="feed_composer_visibility_friends"/>
                        <ComboBoxItem x:Uid="feed_composer_visibility_best_friends"/>
                    </ComboBox>
                </Grid>

                <Grid x:Name="PublishDateInfo" Visibility="{Binding CanPublishPostponed, Converter={StaticResource ntv}}">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="96"/>
                        <ColumnDefinition/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Margin="6,0,0,0" VerticalAlignment="Center" x:Uid="feed_composer_scheduled_time"/>
                    <muxc:DropDownButton Grid.Column="1" Margin="6" HorizontalAlignment="Stretch" HorizontalContentAlignment="Left" Content="{Binding PublishTime, Converter={StaticResource dtc}}">
                        <muxc:DropDownButton.Flyout>
                            <Flyout Placement="Bottom" Opening="OnDateTimePickerFlyoutOpened">
                                <StackPanel>
                                    <CalendarView x:Name="PPDatePicker" BorderThickness="0" Background="Transparent" SelectionMode="Single" SelectedDatesChanged="OnDateChanged"/>
                                    <TimePicker x:Name="PPTimePicker" Margin="12" HorizontalAlignment="Stretch" TimeChanged="OnTimeChanged"/>
                                </StackPanel>
                            </Flyout>
                        </muxc:DropDownButton.Flyout>
                    </muxc:DropDownButton>
                    <Button Grid.Column="2" Margin="6,0" Style="{StaticResource AttachButtonStyle}" Visibility="{Binding PublishTime, Converter={StaticResource ntv}}" Content="" Command="{Binding RemovePublishTimeCommand}"/>
                </Grid>

                <CheckBox x:Name="FromGroupCB" Margin="6,0" IsChecked="{Binding PostAsGroup, Mode=TwoWay}" Visibility="{Binding CanPublishFromUserInGroup, Converter={StaticResource ntv}}" x:Uid="feed_composer_from_group"/>
                <CheckBox x:Name="DisableCommentsCB" Margin="6,0" IsEnabled="{Binding PostAsGroup}" IsChecked="{Binding DisableComments, Mode=TwoWay}" Visibility="{Binding CanDisableComments, Converter={StaticResource ntv}}" x:Uid="feed_composer_no_comments"/>
                <CheckBox x:Name="SignerCB" Margin="6,0" IsEnabled="{Binding PostAsGroup}" IsChecked="{Binding ShowSigner, Mode=TwoWay}" Visibility="{Binding CanPostWithSigner, Converter={StaticResource ntv}}" x:Uid="feed_composer_sign"/>
                <CheckBox x:Name="DisableNotificationsCB" Margin="6,0" IsEnabled="{Binding PostAsGroup}" IsChecked="{Binding DisableNotifications, Mode=TwoWay}" Visibility="{Binding CanDisableNotifications, Converter={StaticResource ntv}}" x:Uid="feed_composer_no_notifications"/>
            </StackPanel>
        </Flyout>
    </UserControl.Resources>

    <Grid>
        <Grid x:Name="ComposerBase">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            <TextBox x:Name="PostText" TextWrapping="Wrap" AcceptsReturn="True" BorderThickness="0" Padding="12,9,12,12" MinHeight="78" Background="Transparent" MaxLength="16000" PlaceholderText="{Binding PlaceholderText}" Text="{Binding Text, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                <TextBox.Resources>
                    <SolidColorBrush x:Key="TextControlBorderBrushFocused" Color="Transparent"/>
                    <SolidColorBrush x:Key="TextControlBackgroundFocused" Color="Transparent"/>
                    <SolidColorBrush x:Key="TextControlBackgroundPointerOver" Color="Transparent"/>
                </TextBox.Resources>
            </TextBox>

            <GridView x:Name="OutboundAttachments" Grid.Row="1" VerticalAlignment="Bottom" Margin="6,0,0,6" Padding="0" Visibility="{Binding HasAttachments, Converter={StaticResource ntv}, TargetNullValue=Collapsed, FallbackValue=Collapsed}" ItemsSource="{Binding Attachments}">
                <GridView.ItemTemplate>
                    <DataTemplate x:DataType="vmc:OutboundAttachmentViewModel">
                        <local:OutboundAttachmentUI Width="104" Height="78" DataContext="{x:Bind}" OnRemoveButtonClick="RemoveOutboundAttachment"/>
                    </DataTemplate>
                </GridView.ItemTemplate>
                <GridView.ItemContainerStyle>
                    <Style TargetType="GridViewItem">
                        <Setter Property="Margin" Value="6"/>
                    </Style>
                </GridView.ItemContainerStyle>
            </GridView>

            <TextBlock x:Name="debug" x:DeferLoadStrategy="Lazy" Grid.RowSpan="2" IsHitTestVisible="False" Opacity="0.7" FontFamily="Lucida Console" FontSize="11" Foreground="{ThemeResource SystemControlErrorTextForegroundBrush}" VerticalAlignment="Bottom"/>

            <Grid Margin="12,0,12,12" Grid.Row="2" Visibility="{Binding Geopoint, Mode=OneWay, Converter={StaticResource ntv}}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition/>
                </Grid.ColumnDefinitions>
                <local:FixedFontIcon Glyph="" Margin="0,4" Foreground="{ThemeResource AccentTextFillColorSecondaryBrush}"/>
                <TextBlock Grid.Column="1" Margin="12,0" FontSize="12" LineHeight="16" LineStackingStrategy="BlockLineHeight" VerticalAlignment="Center" Text="{Binding Geopoint, Converter={StaticResource gps}}" FontWeight="SemiBold" Foreground="{ThemeResource AccentTextFillColorSecondaryBrush}"/>
                <HyperlinkButton Grid.Column="2" Width="24" Height="24" Padding="4" Foreground="{ThemeResource AccentTextFillColorSecondaryBrush}" FontSize="16" FontFamily="{StaticResource SymbolThemeFontFamily}" Content="" Command="{Binding RemoveLocationCommand}"/>
            </Grid>

            <Grid Grid.Row="3" BorderThickness="0,1,0,0" Padding="12" BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <StackPanel Orientation="Horizontal">
                    <Button win1809:Style="{StaticResource LeftSideButtonStyle}" nonWin1809:Style="{StaticResource LeftSideButtonStyleLegacy}" Content="" Command="{Binding AttachPhotoCommand}" x:Uid="photoButton"/>
                    <Button win1809:Style="{StaticResource MiddleSideButtonStyle}" nonWin1809:Style="{StaticResource MiddleSideButtonStyleLegacy}" Content="" Command="{Binding AttachVideoCommand}" x:Uid="videoButton"/>
                    <muxc:SplitButton x:Name="splitButton" BorderThickness="0,1,1,1" Padding="7,8" Command="{Binding AttachFileCommand}" x:Uid="fileButton">
                        <muxc:SplitButton.Flyout>
                            <MenuFlyout Placement="Bottom">
                                <MenuFlyoutItem x:Uid="atchpicker_audio" Command="{Binding AttachAudioCommand}">
                                    <MenuFlyoutItem.Icon>
                                        <local:FixedFontIcon Glyph=""/>
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                                <MenuFlyoutItem x:Uid="atchpicker_poll" Command="{Binding AttachPollCommand}">
                                    <MenuFlyoutItem.Icon>
                                        <local:FixedFontIcon Glyph=""/>
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                                <!--<MenuFlyoutItem x:Uid="atchpicker_geo" Command="{Binding AttachLocationCommand}">
                        <MenuFlyoutItem.Icon>
                            <local:FixedFontIcon Glyph=""/>
                        </MenuFlyoutItem.Icon>
                    </MenuFlyoutItem>-->
                            </MenuFlyout>
                        </muxc:SplitButton.Flyout>
                        <local:FixedFontIcon Glyph=""/>
                    </muxc:SplitButton>
                </StackPanel>
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button win1809:Style="{StaticResource AttachButtonStyle}" nonWin1809:Style="{StaticResource AttachButtonStyleLegacy}" Flyout="{StaticResource DonsParamsFlyout}" Visibility="{Binding CanPublishOnlyForDons, Converter={StaticResource ntv}}" Content=""/>
                    <Button Margin="0,0,3,0" win1809:Style="{StaticResource AttachButtonStyle}" nonWin1809:Style="{StaticResource AttachButtonStyleLegacy}" Flyout="{StaticResource PostParamsFlyout}" Visibility="{Binding SettingsAvailable, Converter={StaticResource ntv}}" Content=""/>
                    <Button Margin="3,0,0,0" Style="{StaticResource AccentButtonStyle}" FontFamily="{ThemeResource ContentControlThemeFontFamily}" Height="32" Command="{Binding PublishCommand}" Content="{Binding PostButtonText}"/>
                </StackPanel>
            </Grid>
        </Grid>

        <Grid x:Name="DropArea" Grid.RowSpan="4" Visibility="Collapsed" Padding="6" AllowDrop="True">
            <Grid.ColumnDefinitions>
                <ColumnDefinition/>
                <ColumnDefinition/>
            </Grid.ColumnDefinitions>
            <Grid x:Name="DropDoc" Visibility="Collapsed" AllowDrop="True" Grid.Column="0" Margin="6" Background="Transparent" BorderThickness="1" BorderBrush="{ThemeResource AccentTextFillColorTertiaryBrush}" Drop="DropToDoc">
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <local:FixedFontIcon Foreground="{ThemeResource AccentTextFillColorTertiaryBrush}" FontSize="32" Glyph=""/>
                    <TextBlock x:Name="DropDocText" Margin="12,9,12,0" FontSize="14" TextWrapping="Wrap" TextAlignment="Center" Foreground="{ThemeResource AccentTextFillColorTertiaryBrush}"/>
                </StackPanel>
            </Grid>
            <Grid x:Name="DropImg" Visibility="Collapsed" AllowDrop="True" Grid.Column="1" Margin="6" Background="Transparent" BorderThickness="1" BorderBrush="{ThemeResource AccentTextFillColorTertiaryBrush}" Drop="DropToImg">
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <local:FixedFontIcon Foreground="{ThemeResource AccentTextFillColorTertiaryBrush}" FontSize="32" Glyph=""/>
                    <TextBlock Margin="12,9,12,0" FontSize="14" TextWrapping="Wrap" TextAlignment="Center" Foreground="{ThemeResource AccentTextFillColorTertiaryBrush}" x:Uid="cv_drop_photo_post"/>
                </StackPanel>
            </Grid>
            <Grid x:Name="DropVid" Visibility="Collapsed" AllowDrop="True" Grid.Column="1" Margin="6" Background="Transparent" BorderThickness="1" BorderBrush="{ThemeResource AccentTextFillColorTertiaryBrush}" Drop="DropToVid">
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <local:FixedFontIcon Foreground="{ThemeResource AccentTextFillColorTertiaryBrush}" FontSize="32" Glyph=""/>
                    <TextBlock Margin="12,9,12,0" FontSize="14" TextWrapping="Wrap" TextAlignment="Center" Foreground="{ThemeResource AccentTextFillColorTertiaryBrush}" x:Uid="cv_drop_video_post"/>
                </StackPanel>
            </Grid>
        </Grid>
    </Grid>
</UserControl>